@page "/entries-search"
@using System.Text.Json
@inject IEntriesSearchViewModel ViewModel
@inject IMessenger Messenger
@inject NavigationManager NavigationManager

<MudAppBar Elevation="7" Color="Color.Primary">
    <LogoAppBar />
    <MudStack Row="true" Justify="Justify.FlexEnd" Style="width: 70%">
        <MudButton Variant="Variant.Filled" Color="Color.Primary" Style="color: white;" DisableElevation="true" DisableRipple="true"
                   Href="/" StartIcon="@Icons.Material.Filled.Home">Return to table</MudButton>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" Style="color: white;" DisableElevation="true" DisableRipple="true"
                   Href="https://github.com/echemdb" StartIcon="@Icons.Custom.Brands.GitHub">GitHub</MudButton>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" Style="color: white;" DisableElevation="true" DisableRipple="true"
                   Href="https://echemdb.github.io/unitpackage/index.html" StartIcon="@Icons.Custom.FileFormats.FileDocument">Documentation</MudButton>
        <ThemeButton />
    </MudStack>
</MudAppBar>

<MudStack Class="pa-10">
    <MudStack Row="true">
        <MudText Typo="Typo.h3"><b>Search results of the element(s):</b></MudText>
        <MudSpacer />
        
    </MudStack>
    <MudStack Class="mt-5" Row="true">
        @foreach (var element in ViewModel.Elements)
        {
            <ElementCard Element="element"/>
        }
    </MudStack>
</MudStack>

<MudStack Class="pa-10">
    <MudDataGrid T="CVEntry" Items="@ViewModel.Entries" Filterable="true" SortMode="SortMode.Multiple" Hideable="false" Hover="true"
                 FilterCaseSensitivity="DataGridFilterCaseSensitivity.CaseInsensitive" Groupable="true" Elevation="6">
        <ToolBarContent>
            <MudText Class="ml-5 mt-5" Typo="Typo.h3"> Entries </MudText>
        </ToolBarContent>
        <Columns>
            <PropertyColumn Property="x => x.Name"/>
            <PropertyColumn Title="Material" Property="x => x.We_Electrode._Descriptor.Material"/>
            <PropertyColumn Title="Orientation" Property="x => x.We_Electrode._Descriptor.Crystallographic_Orientation"/>
            <PropertyColumn Title="Eletrolyte" Property="x => x.Electrolyte.Components[0]"/>
            <PropertyColumn Title="Year" Property="x => x.Bibliography.Year"/>
        </Columns>
        <PagerContent>
            <MudDataGridPager T="CVEntry" />
        </PagerContent>
    </MudDataGrid>
</MudStack>

@code {

    protected override void OnInitialized()
    {
        Deserialize();
    }

    protected override async Task OnInitializedAsync()
    {
        await ViewModel.OnInitializedAsync();
    }

    private void Deserialize()
    {
        var urlParameter = NavigationManager.Uri;
        var queryString = Uri.UnescapeDataString(new Uri(urlParameter).Query.TrimStart('?'));
        Console.WriteLine($"serializing JSON list: {queryString}");

        if (!string.IsNullOrEmpty(queryString))
        {
            var serializedList = Uri.UnescapeDataString(queryString.Split('=')[1]);
            try
            {
                ViewModel.Elements = JsonSerializer.Deserialize<List<Element>>(serializedList) ?? new List<Element>();
            }
            catch (JsonException ex)
            {
                // Log or handle the exception
                Console.WriteLine($"Error deserializing JSON: {ex.Message}");
            }
        }
    }

    private string material = "_descriptor";
}
